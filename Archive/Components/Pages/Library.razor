@page "/library"
@using Microsoft.EntityFrameworkCore
@using Archive.Models
@using Archive.Data
@inject IServiceScopeFactory ScopeFactory
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>My Collection</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-6" Spacing="4">
        <MudText Typo="Typo.h3">ðŸ“š Library</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" 
                      Placeholder="Search title, author, or publisher..." 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" 
                      IconSize="Size.Medium" 
                      Class="mt-0" 
                      Clearable="true"
                      Immediate="true" />
        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadBooks">
            Refresh
        </MudButton>
    </MudStack>

    @if (isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Class="mt-10">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Class="mt-2">Dusting off the shelves...</MudText>
        </MudStack>
    }
    else if (!FilteredBooks.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
            No books found matching "<strong>@searchString</strong>".
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var file in FilteredBooks)
            {
                @if (file.Book == null) continue;

                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="3" Class="h-100 d-flex flex-column hover-effect">
                        
                        @if (!string.IsNullOrEmpty(file.Book.CoverPath))
                        {
                            <MudCardMedia Image="@file.Book.CoverPath" Height="200" />
                        }
                        else
                        {
                            <div class="d-flex align-center justify-center pa-4" 
                                 style="@($"height: 200px; background-color: {GetColor(file.Book.Title)}; color: white;")">
                                <MudText Typo="Typo.h5" Align="Align.Center">@GetInitials(file.Book.Title)</MudText>
                            </div>
                        }

                        <MudCardContent Class="flex-grow-1">
                            <MudText Typo="Typo.h6" Class="text-truncate">@file.Book.Title</MudText>
                            <MudText Typo="Typo.body2" Class="mb-2">@file.Book.Author</MudText>
                            
                            <MudStack Row="true" Spacing="1">
                                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">
                                    @file.Extension.ToUpper().Replace(".", "")
                                </MudChip>
                                
                                @if (!string.IsNullOrWhiteSpace(file.Book.Category) && file.Book.Category != "Uncategorized")
                                {
                                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Variant="Variant.Text">
                                        @file.Book.Category.Split(new[]{','}, StringSplitOptions.RemoveEmptyEntries).FirstOrDefault()
                                    </MudChip>
                                }
                            </MudStack>
                        </MudCardContent>

                        <MudCardActions>
                            <MudText Typo="Typo.caption" Class="ml-2 text-muted">@FormatSize(file.SizeBytes)</MudText>
                            <MudSpacer />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ConfirmDelete(file)" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .hover-effect {
        transition: transform 0.2s;
    }
    .hover-effect:hover {
        transform: translateY(-5px);
    }
    .text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

@code {
    private List<LibraryFile> books = new List<LibraryFile>();
    private bool isLoading = true;
    private string searchString = "";

    private IEnumerable<LibraryFile> FilteredBooks =>
        string.IsNullOrWhiteSpace(searchString) 
        ? books 
        : books.Where(b => b.Book != null && ( // Null check here too
            (b.Book.Title?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (b.Book.Author?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (b.Book.Publisher?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
        ));

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        isLoading = true;
        using (var scope = ScopeFactory.CreateScope())
        {
            var db = scope.ServiceProvider.GetRequiredService<LibraryDbContext>();
            books = await db.LibraryFiles
                            .Include(f => f.Book)
                            .OrderBy(f => f.Book!.Title) // Null-forgiving operator
                            .ToListAsync();
        }
        isLoading = false;
    }

    private async Task ConfirmDelete(LibraryFile file)
    {
        if (file.Book == null) return;

        bool? result = await DialogService.ShowMessageBox(
            "Warning", 
            $"Deleting '{file.Book.Title}' cannot be undone!", 
            yesText:"Delete!", cancelText:"Cancel");

        if (result == true)
        {
            using (var scope = ScopeFactory.CreateScope())
            {
                var db = scope.ServiceProvider.GetRequiredService<LibraryDbContext>();
                var fileToDelete = await db.LibraryFiles.FindAsync(file.Id);
                if (fileToDelete != null)
                {
                    db.LibraryFiles.Remove(fileToDelete);
                    await db.SaveChangesAsync();
                }
            }
            books.Remove(file);
            StateHasChanged();
        }
    }

    // --- Helpers ---

    private string GetColor(string? title)
    {
        if (string.IsNullOrEmpty(title)) return "#546E7A";
        var colors = new[] { "#1E88E5", "#43A047", "#E53935", "#FB8C00", "#8E24AA", "#546E7A" };
        int index = Math.Abs(title.GetHashCode()) % colors.Length;
        return colors[index];
    }

    private string GetInitials(string? title)
    {
        if (string.IsNullOrWhiteSpace(title)) return "?";
        
        // CRASH FIX: RemoveEmptyEntries prevents crashing on double spaces like "The  Book"
        var parts = title.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        
        if (parts.Length == 0) return "?";
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        
        return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpper();
    }

    private string FormatSize(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB" };
        int counter = 0;
        decimal number = (decimal)bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number = number / 1024;
            counter++;
        }
        return string.Format("{0:n1} {1}", number, suffixes[counter]);
    }
}